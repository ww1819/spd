<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.spd.warehouse.mapper.StkIoBillMapper">

    <resultMap type="StkIoBill" id="StkIoBillResult">
        <result property="id"    column="id"    />
        <result property="billNo"    column="bill_no"    />
        <result property="refBillNo"    column="ref_bill_no"    />
        <result property="supplerId"    column="suppler_id"    />
        <result property="billDate"    column="bill_date"    />
        <result property="warehouseId"    column="warehouse_id"    />
        <result property="departmentId"    column="department_id"    />
        <result property="billStatus"    column="bill_status"    />
        <result property="userId"    column="stk_user_id"    />
        <result property="billType"    column="bill_type"    />
        <result property="delFlag"    column="del_flag"    />
        <result property="auditDate"    column="audit_date"    />
        <result property="createBy"    column="create_by"    />
        <result property="createTime"    column="create_time"    />
        <result property="updateBy"    column="update_by"    />
        <result property="updateTime"    column="update_time"    />
        <result property="remark"    column="remark"    />
        <result property="delPerson"    column="del_person"    />
        <result property="telephone"    column="telephone"    />
        <result property="totalAmount"    column="total_amount"    />
        <result property="invoiceNumber"    column="invoice_number"    />
        <result property="invoiceAmount"    column="invoice_amount"    />
        <result property="invoiceTime"    column="invoice_time"    />
        <result property="proPerson"    column="pro_person"    />
        <result property="returnReason"    column="return_reason"    />
        <result property="isMonthInit"    column="is_month_init"    />
        <result property="receiptConfirmStatus"    column="receipt_confirm_status"    />
        <result property="auditBy"    column="audit_by"    />
        <result property="createrName"    column="createrUserName"    />
        <result property="auditPersonName"    column="auditUserName"    />
        <result property="updateByUserName"    column="updateByUserName"    />
        <result property="updateByNickName"    column="updateByNickName"    />

        <association property="supplier"    column="id" javaType="FdSupplier" resultMap="supplierResult" />
        <association property="department"    column="id" javaType="FdDepartment" resultMap="departmentResult" />
        <association property="warehouse"    column="id" javaType="FdWarehouse" resultMap="warehouseResult" />
        <association property="toWarehouse"    column="id" javaType="FdWarehouse" resultMap="toWarehouseResult" />
        <association property="user"    column="user_id" javaType="SysUser" resultMap="userResult" />
        <association property="auditPerson"    column="user_id" javaType="SysUser" resultMap="auditUserResult" />
        <association property="creater"    column="user_id" javaType="SysUser" resultMap="createrResult" />
    </resultMap>

    <resultMap id="supplierResult" type="FdSupplier">
        <id     property="id"    column="sId"     />
        <result property="code"  column="supplierCode"   />
        <result property="name"  column="supplierName"   />
    </resultMap>

    <resultMap id="departmentResult" type="FdDepartment">
        <id     property="id"    column="dId"     />
        <result property="code"  column="departmentCode"   />
        <result property="name"  column="departmentName"   />
    </resultMap>

    <resultMap id="warehouseResult" type="FdWarehouse">
        <id     property="id"    column="wId"     />
        <result property="code"  column="warehouseCode"   />
        <result property="name"  column="warehouseName"   />
    </resultMap>

    <resultMap id="toWarehouseResult" type="FdWarehouse">
        <id     property="id"    column="twId"     />
        <result property="code"  column="toWarehouseCode"   />
        <result property="name"  column="toWarehouseName"   />
    </resultMap>

    <resultMap id="userResult" type="SysUser">
        <id     property="userId"    column="userId"     />
        <result property="nickName"  column="nickName"   />
        <result property="userName"  column="userName"   />
    </resultMap>

    <resultMap id="auditUserResult" type="SysUser">
        <id     property="userId"    column="audit_by"     />
        <result property="nickName"  column="auditNickName"   />
        <result property="userName"  column="auditUserName"   />
    </resultMap>

    <resultMap id="createrResult" type="SysUser">
        <id     property="userId"    column="create_by"     />
        <result property="nickName"  column="createrNickName"   />
        <result property="userName"  column="createrUserName"   />
    </resultMap>

    <resultMap id="StkIoBillStkIoBillEntryResult" type="StkIoBill" extends="StkIoBillResult">
        <collection property="stkIoBillEntryList" notNullColumn="sub_id" javaType="java.util.List" resultMap="StkIoBillEntryResult" />
    </resultMap>

    <resultMap type="StkIoBillEntry" id="StkIoBillEntryResult">
        <result property="id"    column="sub_id"    />
        <result property="parenId"    column="sub_paren_id"    />
        <result property="commodityId"    column="sub_commodity_id"    />
        <result property="materialId"    column="sub_material_id"    />
        <result property="unitPrice"    column="sub_unit_price"    />
        <result property="qty"    column="sub_qty"    />
        <result property="price"    column="sub_price"    />
        <result property="amt"    column="sub_amt"    />
        <result property="batchNo"    column="sub_batch_no"    />
        <result property="batchNumber"    column="sub_batch_number"    />
        <result property="beginTime"    column="sub_begin_time"    />
        <result property="endTime"    column="sub_end_time"    />
        <result property="delFlag"    column="sub_del_flag"    />
        <result property="remark"    column="sub_remark"    />
        <result property="kcNo"    column="sub_kc_no"    />
        <result property="warehouseName"    column="warehouseName"    />
        <result property="settlementType"    column="settlementType"    />
        <association property="material"    column="id" javaType="FdMaterial" resultMap="materialResult" />
    </resultMap>

    <resultMap id="materialResult" type="FdMaterial">
        <id     property="id"    column="mId"     />
        <result property="code"  column="materialCode"   />
        <result property="name"  column="materialName"   />
        <result property="speci"  column="speci"   />
        <result property="model"  column="model"   />
        <result property="supplierId"  column="supplier_id"   />
        <result property="storeroomId"  column="storeroom_id"   />
        <result property="factoryId"  column="factory_id"   />
        <result property="unitId"  column="unit_id"   />
        <result property="financeCategoryId"  column="finance_category_id"   />
        <result property="packageSpeci"  column="package_speci"   />
        <result property="registerNo"  column="register_no"   />
        <association property="fdUnit" javaType="FdUnit">
            <id     property="unitId"    column="unit_id"     />
            <result property="unitCode"  column="u_code"   />
            <result property="unitName"  column="u_name"   />
        </association>
        <association property="fdFactory" javaType="FdFactory">
            <id     property="factoryId"    column="factory_id"     />
            <result property="factoryCode"  column="f_code"   />
            <result property="factoryName"  column="f_name"   />
        </association>
        <association property="fdWarehouseCategory" javaType="FdWarehouseCategory">
            <id     property="warehouseCategoryId"    column="wid"     />
            <result property="warehouseCategoryCode"  column="wc_code"   />
            <result property="warehouseCategoryName"  column="wc_name"   />
        </association>
        <association property="fdFinanceCategory" javaType="FdFinanceCategory">
            <id     property="financeCategoryId"    column="finance_category_id"     />
            <result property="financeCategoryCode"  column="fc_code"   />
            <result property="financeCategoryName"  column="fc_name"   />
        </association>
        <association property="supplier" javaType="FdSupplier">
            <id     property="id"    column="sid"     />
            <result property="code"  column="supplier_code"   />
            <result property="name"  column="supplier_name"   />
        </association>
    </resultMap>


    <sql id="selectStkIoBillVo">
        select stk.id, stk.bill_no, stk.ref_bill_no, stk.suppler_id stkSupplierId, stk.bill_date, stk.warehouse_id, stk.department_id,
				stk.bill_status, stk.user_id stk_user_id, stk.bill_type, stk.del_flag,stk.audit_date, stk.create_by, stk.create_time,
				stk.update_by, stk.update_time, stk.remark,stk.del_person,stk.telephone,stk.total_amount,stk.invoice_number,stk.invoice_amount,
				stk.invoice_time,stk.pro_person,stk.return_reason,stk.is_month_init,stk.receipt_confirm_status,stk.audit_by,
				s.id sId,s.code supplierCode,s.name supplierName,
				d.id dId,d.code departmentCode,d.name departmentName,
				w.id wId,w.code warehouseCode,w.name warehouseName,
				tw.id twId,tw.code toWarehouseCode,tw.name toWarehouseName,
				u.user_id userId,u.nick_name nickName,u.user_name userName,
               au.nick_name auditNickName,au.user_name auditUserName,
               cu.nick_name createrNickName,cu.user_name createrUserName,
               uu.nick_name updateByNickName,uu.user_name updateByUserName
        from stk_io_bill stk
        left join fd_supplier s on stk.suppler_id = s.id
        left join fd_department d on stk.department_id = d.id
        left join fd_warehouse w on stk.warehouse_id = w.id
        left join fd_warehouse tw on stk.department_id = tw.id and stk.bill_type = 501
        left join sys_user u on stk.user_id = u.user_id
        left join sys_user au on stk.audit_by = au.user_id
        left join sys_user cu on stk.create_by = cu.user_id
        left join sys_user uu on stk.update_by = uu.user_id
    </sql>

    <sql id="selectStkIoBillTotalVo">
        select sum(stk.total_amount) totalAmt,
               sum(case when stk.bill_type in (101) then stk.total_amount else 0 end) totalRkAmt,
               sum(case when stk.bill_type in (201) then stk.total_amount else 0 end) totalCkAmt,
               sum(case when stk.bill_type in (301) then stk.total_amount else 0 end) totalTkAmt,
               sum(case when stk.bill_type in (401) then stk.total_amount else 0 end) totalThAmt
        from stk_io_bill stk
                 left join fd_supplier s on stk.suppler_id = s.id
                 left join fd_department d on stk.department_id = d.id
                 left join fd_warehouse w on stk.warehouse_id = w.id
                 left join sys_user u on stk.user_id = u.user_id
                 left join sys_user au on stk.audit_by = au.user_id
                 left join sys_user cu on stk.create_by = cu.user_id
    </sql>

    <select id="selectStkIoBillList" parameterType="StkIoBill" resultMap="StkIoBillResult">
        <include refid="selectStkIoBillVo"/>
        where stk.del_flag != 1
        <if test="billNo != null  and billNo != ''"> and stk.bill_no like concat('%', #{billNo}, '%')</if>
        <if test="supplerId != null "> and stk.suppler_id = #{supplerId}</if>
        <if test="warehouseId != null "> and stk.warehouse_id = #{warehouseId}</if>
        <if test="departmentId != null "> and stk.department_id = #{departmentId}</if>
        <if test="billStatus != null "> and stk.bill_status = #{billStatus}</if>
        <if test="userId != null "> and stk.user_id = #{userId}</if>
        <if test="billType != null "> 
            and stk.bill_type = #{billType}
            <!-- 如果是调拨单(billType=501)，排除JS开头的结算单据 -->
            <if test="billType == 501"> and stk.bill_no not like 'JS%'</if>
        </if>

        <if test="beginDate != null "> and stk.bill_date &gt;= #{beginDate}</if>
        <if test="endDate != null "> and stk.bill_date &lt;= #{endDate}</if>
        <if test="auditBeginDate != null "> and stk.audit_date &gt;= #{auditBeginDate}</if>
        <if test="auditEndDate != null "> and DATE(stk.audit_date) &lt;= DATE(#{auditEndDate})</if>
        <if test="receiptConfirmStatus != null "> and stk.receipt_confirm_status = #{receiptConfirmStatus}</if>
        <if test="materialName != null and materialName != ''"> and exists (select 1 from stk_io_bill_entry e inner join fd_material m on e.material_id = m.id where e.parent_id = stk.id and (m.name like concat('%', #{materialName}, '%') or m.code like concat('%', #{materialName}, '%')))</if>
        order by stk.bill_date desc
    </select>

    <select id="selectStkIoBillTotal" parameterType="StkIoBill" resultType="com.spd.common.core.page.TotalInfo">
        <include refid="selectStkIoBillTotalVo"/>
        where stk.del_flag != 1
        <if test="billNo != null  and billNo != ''"> and stk.bill_no like concat('%', #{billNo}, '%')</if>
        <if test="supplerId != null "> and stk.suppler_id = #{supplerId}</if>
        <if test="warehouseId != null "> and stk.warehouse_id = #{warehouseId}</if>
        <if test="departmentId != null "> and stk.department_id = #{departmentId}</if>
        <if test="billStatus != null "> and stk.bill_status = #{billStatus}</if>
        <if test="userId != null "> and stk.user_id = #{userId}</if>
        <if test="billType != null "> and stk.bill_type = #{billType}</if>

        <if test="beginDate != null "> and stk.bill_date &gt;= #{beginDate}</if>
        <if test="endDate != null "> and stk.bill_date &lt;= #{endDate}</if>
        order by stk.bill_date desc
    </select>

    <select id="selectRTHStkIoBillList" parameterType="StkIoBill" resultType="java.util.HashMap">
        select stk.id,m.code materialCode,m.name materialName, stk.bill_no billNo, stk.bill_date billDate,
                stk.bill_type billType,b.qty materialQty, b.unit_price unitPrice,
                b.amt materialAmt, b.batch_no batchNo, b.batch_number batchNumber, b.begin_time beginTime,
                b.end_time endTime,m.speci materialSpeci,m.model materialModel,u.unit_name unitName,
                f.factory_name factoryName,fc.finance_category_name financeCategoryName,
                s.name supplierName, w.name warehouseName,b.material_id materialId
        from stk_io_bill stk
        left join stk_io_bill_entry b on b.paren_id = stk.id
        left join fd_supplier s on stk.suppler_id = s.id
        left join fd_warehouse w on stk.warehouse_id = w.id
        left join fd_material m on b.material_id = m.id
        left join fd_factory f on f.factory_id = m.factory_id
        left join fd_unit u on u.unit_id = m.unit_id
        left join fd_finance_category fc on fc.finance_category_id = m.finance_category_id
        where stk.del_flag != 1
        and stk.bill_type in (101,301)
        <if test="billNo != null  and billNo != ''"> and stk.bill_no like concat('%', #{billNo}, '%')</if>
        <if test="supplerId != null "> and stk.suppler_id = #{supplerId}</if>
        <if test="warehouseId != null "> and stk.warehouse_id = #{warehouseId}</if>
        <if test="materialId != null "> and m.id = #{materialId}</if>
        <choose>
            <when test="billStatus != null">
                and stk.bill_status = #{billStatus}
            </when>
            <otherwise>
                and stk.bill_status =2
            </otherwise>
        </choose>
        <if test="beginDate != null "> and stk.bill_date &gt;= #{beginDate}</if>
        <if test="endDate != null "> and stk.bill_date &lt;= #{endDate}</if>
        <if test="billType != null "> and stk.bill_Type = #{billType}</if>
    </select>

    <select id="selectRTHStkIoBillSummaryList" parameterType="StkIoBill" resultType="java.util.HashMap">
        select stk.id,m.code materialCode,m.name materialName, stk.bill_type billType,
                sum(b.qty) materialQty, b.price unitPrice,ROUND(sum(b.qty) * b.price, 2) materialAmt,
                m.speci materialSpeci,m.model materialModel,u.unit_name unitName,
                f.factory_name factoryName,s.name supplierName, w.name warehouseName,b.material_id materialId
        from stk_io_bill stk
        left join stk_io_bill_entry b on b.paren_id = stk.id
        left join fd_supplier s on stk.suppler_id = s.id
        left join fd_warehouse w on stk.warehouse_id = w.id
        left join fd_material m on b.material_id = m.id
        left join fd_factory f on f.factory_id = m.factory_id
        left join fd_unit u on u.unit_id = m.unit_id
        where stk.del_flag != 1
        and stk.bill_type in (101,301)
        and stk.bill_status = 2
        <if test="billNo != null  and billNo != ''"> and stk.bill_no like concat('%', #{billNo}, '%')</if>
        <if test="supplerId != null "> and stk.suppler_id = #{supplerId}</if>
        <if test="warehouseId != null "> and stk.warehouse_id = #{warehouseId}</if>

        <if test="beginDate != null "> and stk.bill_date &gt;= #{beginDate}</if>
        <if test="endDate != null "> and stk.bill_date &lt;= #{endDate}</if>
        GROUP BY stk.id,m.code,m.name, stk.bill_type,
         b.price,
        m.speci,m.model,u.unit_name,
        f.factory_name,s.name, w.name,b.material_id
    </select>

    <select id="selectCTKStkIoBillListSummary" parameterType="StkIoBill" resultType="java.util.HashMap">
        select stk.id,m.code materialCode,m.name materialName, stk.bill_type billType,
                sum(b.qty) materialQty, b.unit_price unitPrice,ROUND(sum(b.qty) * b.unit_price, 2) materialAmt,
                m.speci materialSpeci,m.model materialModel,u.unit_name unitName,
                f.factory_name factoryName,d.name departmentName, w.name warehouseName,b.material_id materialId
        from stk_io_bill stk
        left join stk_io_bill_entry b on b.paren_id = stk.id and (b.del_flag is null or b.del_flag != 1)
        left join fd_department d on stk.department_id = d.id
        left join fd_warehouse w on stk.warehouse_id = w.id
        left join fd_material m on b.material_id = m.id
        left join fd_factory f on f.factory_id = m.factory_id
        left join fd_unit u on u.unit_id = m.unit_id
        where (stk.del_flag = 0 or stk.del_flag is null)
        and stk.bill_type in (201,401)
        and stk.bill_status = 2
        <if test="billNo != null  and billNo != ''"> and stk.bill_no like concat('%', #{billNo}, '%')</if>
        <if test="departmentId != null "> and stk.department_id = #{departmentId}</if>
        <if test="warehouseId != null "> and stk.warehouse_id = #{warehouseId}</if>

        <if test="beginDate != null "> and stk.bill_date &gt;= #{beginDate}</if>
        <if test="endDate != null "> and stk.bill_date &lt;= #{endDate}</if>
        GROUP BY stk.id,m.code,m.name, stk.bill_type, b.unit_price,
        m.speci,m.model,u.unit_name,
        f.factory_name,d.name, w.name,b.material_id
    </select>

    <select id="selectCTKStkIoBillList" parameterType="StkIoBill" resultType="java.util.HashMap">
        select stk.id,m.code materialCode,m.name materialName, stk.bill_no billNo, stk.bill_date billDate,
                stk.bill_type billType,b.qty materialQty, 
                IFNULL(b.unit_price, 
                    IFNULL(
                        CASE 
                            WHEN b.amt IS NOT NULL AND b.qty IS NOT NULL AND b.qty > 0 
                            THEN ROUND(b.amt / b.qty, 2)
                            ELSE NULL 
                        END,
                        IFNULL(
                            (select inv.unit_price 
                             from stk_inventory inv
                             where inv.batch_no = b.batch_no 
                               and inv.material_id = b.material_id
                               and inv.warehouse_id = stk.warehouse_id
                               and inv.qty > 0
                             order by inv.id desc
                             limit 1
                            ),
                            IFNULL(
                                (select inv.unit_price 
                                 from stk_inventory inv
                                 where inv.batch_no = b.batch_no 
                                   and inv.material_id = b.material_id
                                   and inv.qty > 0
                                 order by inv.id desc
                                 limit 1
                                ),
                                (select COALESCE(entry.unit_price, entry.price)
                                 from stk_io_bill_entry entry
                                 inner join stk_io_bill bill on bill.id = entry.paren_id
                                 where bill.bill_type = 101
                                   and entry.material_id = b.material_id
                                   and entry.batch_no = b.batch_no
                                   and entry.del_flag != 1
                                   and bill.del_flag != 1
                                 order by bill.id desc
                                 limit 1
                                )
                            )
                        )
                    )
                ) as unitPrice,
                b.amt materialAmt, b.batch_no batchNo, b.batch_number batchNumber, b.begin_time beginTime,
                b.end_time endTime,m.speci materialSpeci,m.model materialModel,u.unit_name unitName,
                f.factory_name factoryName,fc.finance_category_name financeCategoryName,
                d.name departmentName, w.name warehouseName,b.material_id materialId
        from stk_io_bill stk
        left join stk_io_bill_entry b on b.paren_id = stk.id and (b.del_flag is null or b.del_flag != 1)
        left join fd_department d on stk.department_id = d.id
        left join fd_warehouse w on stk.warehouse_id = w.id
        left join fd_material m on b.material_id = m.id
        left join fd_factory f on f.factory_id = m.factory_id
        left join fd_unit u on u.unit_id = m.unit_id
        left join fd_finance_category fc on fc.finance_category_id = m.finance_category_id
        where (stk.del_flag = 0 or stk.del_flag is null)
        and stk.bill_type in (201,401)
--         and stk.bill_status = 2
        <if test="billNo != null  and billNo != ''"> and stk.bill_no like concat('%', #{billNo}, '%')</if>
        <if test="warehouseId != null "> and stk.warehouse_id = #{warehouseId}</if>
        <if test="departmentId != null "> and stk.department_id = #{departmentId}</if>
        <if test="materialId != null "> and m.id = #{materialId}</if>
        <choose>
            <when test="billStatus != null">
                and stk.bill_status = #{billStatus}
            </when>
            <otherwise>
                and stk.bill_status =2
            </otherwise>
        </choose>
        <if test="beginDate != null "> and stk.bill_date &gt;= #{beginDate}</if>
        <if test="endDate != null "> and stk.bill_date &lt;= #{endDate}</if>
        <if test="billType != null "> and stk.bill_Type = #{billType}</if>
    </select>


    <select id="selectStkIoBillById" parameterType="Long" resultMap="StkIoBillStkIoBillEntryResult">
        select a.id, a.bill_no, a.ref_bill_no, a.suppler_id, a.bill_date, a.warehouse_id, a.department_id, a.bill_status, a.user_id, a.bill_type, a.del_flag, a.audit_date, a.create_by, a.create_time, a.update_by, a.update_time, a.remark,
                a.del_person,a.telephone,a.total_amount,a.invoice_number,a.invoice_amount,
				a.invoice_time,a.pro_person,a.return_reason,a.is_month_init,a.receipt_confirm_status,
                b.id as sub_id, b.paren_id as sub_paren_id, b.commodity_id as sub_commodity_id, b.material_id as sub_material_id, b.unit_price as sub_unit_price, b.qty as sub_qty, b.price as sub_price,
                b.amt as sub_amt, b.batch_no as sub_batch_no, b.batch_number as sub_batch_number, b.begin_time as sub_begin_time, b.end_time as sub_end_time,
                b.remark as sub_remark, b.kc_no as sub_kc_no,au.nick_name auditNickName,au.user_name auditUserName,
               cu.nick_name createrNickName,cu.user_name createrUserName,a.audit_by,
               m.id as mId, m.code as materialCode, m.name as materialName, m.speci, m.model, m.register_no, m.supplier_id, m.factory_id, m.unit_id, m.finance_category_id, m.storeroom_id,
               u.unit_id, u.unit_code as u_code, u.unit_name as u_name,
               f.factory_id, f.factory_code as f_code, f.factory_name as f_name,
               wc.warehouse_category_id as wid, wc.warehouse_category_code as wc_code, wc.warehouse_category_name as wc_name,
               fc.finance_category_id, fc.finance_category_code as fc_code, fc.finance_category_name as fc_name,
               s.id as sid, s.code as supplier_code, s.name as supplier_name
        from stk_io_bill a
        left join stk_io_bill_entry b on b.paren_id = a.id and (b.del_flag is null or b.del_flag != 1)
        left join fd_material m on b.material_id = m.id
        left join fd_unit u on m.unit_id = u.unit_id
        left join fd_factory f on m.factory_id = f.factory_id
        left join fd_warehouse_category wc on m.storeroom_id = wc.warehouse_category_id
        left join fd_finance_category fc on m.finance_category_id = fc.finance_category_id
        left join fd_supplier s on m.supplier_id = s.id
        left join sys_user au on a.audit_by = au.user_id
        left join sys_user cu on a.create_by = cu.user_id
        where a.id = #{id}
    </select>

    <insert id="insertStkIoBill" parameterType="StkIoBill" useGeneratedKeys="true" keyProperty="id">
        insert into stk_io_bill
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="billNo != null and billNo != ''">bill_no,</if>
            <if test="refBillNo != null and refBillNo != ''">ref_bill_no,</if>
            <if test="supplerId != null">suppler_id,</if>
            <if test="billDate != null">bill_date,</if>
            <if test="warehouseId != null">warehouse_id,</if>
            <if test="departmentId != null">department_id,</if>
            <if test="billStatus != null">bill_status,</if>
            <if test="userId != null">user_id,</if>
            <if test="billType != null">bill_type,</if>
            <if test="delFlag != null">del_flag,</if>
            <if test="auditDate != null">audit_date,</if>
            <if test="createBy != null">create_by,</if>
            <if test="createTime != null">create_time,</if>
            <if test="updateBy != null">update_by,</if>
            <if test="updateTime != null">update_time,</if>
            <if test="remark != null">remark,</if>
            <if test="delPerson != null">del_person,</if>
            <if test="telephone != null">telephone,</if>
            <if test="totalAmount != null">total_amount,</if>
            <if test="invoiceNumber != null">invoice_number,</if>
            <if test="invoiceAmount != null">invoice_amount,</if>
            <if test="invoiceTime != null">invoice_time,</if>
            <if test="proPerson != null">pro_person,</if>
            <if test="returnReason != null and returnReason != ''">return_reason,</if>
            <if test="isMonthInit != null">is_month_init,</if>
            <if test="receiptConfirmStatus != null">receipt_confirm_status,</if>
            <if test="auditBy != null">audit_by,</if>
         </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="billNo != null and billNo != ''">#{billNo},</if>
            <if test="refBillNo != null and refBillNo != ''">#{refBillNo},</if>
            <if test="supplerId != null">#{supplerId},</if>
            <if test="billDate != null">#{billDate},</if>
            <if test="warehouseId != null">#{warehouseId},</if>
            <if test="departmentId != null">#{departmentId},</if>
            <if test="billStatus != null">#{billStatus},</if>
            <if test="userId != null">#{userId},</if>
            <if test="billType != null">#{billType},</if>
            <if test="delFlag != null">#{delFlag},</if>
            <if test="auditDate != null">#{auditDate},</if>
            <if test="createBy != null">#{createBy},</if>
            <if test="createTime != null">#{createTime},</if>
            <if test="updateBy != null">#{updateBy},</if>
            <if test="updateTime != null">#{updateTime},</if>
            <if test="remark != null">#{remark},</if>
            <if test="delPerson != null">#{delPerson},</if>
            <if test="telephone != null">#{telephone},</if>
            <if test="totalAmount != null">#{totalAmount},</if>
            <if test="invoiceNumber != null">#{invoiceNumber},</if>
            <if test="invoiceAmount != null">#{invoiceAmount},</if>
            <if test="invoiceTime != null">#{invoiceTime},</if>
            <if test="proPerson != null">#{proPerson},</if>
            <if test="returnReason != null and returnReason != ''">#{returnReason},</if>
            <if test="isMonthInit != null">#{isMonthInit},</if>
            <if test="receiptConfirmStatus != null">#{receiptConfirmStatus},</if>
            <if test="auditBy != null">#{auditBy},</if>
         </trim>
    </insert>

    <update id="updateStkIoBill" parameterType="StkIoBill">
        update stk_io_bill
        <trim prefix="SET" suffixOverrides=",">
            <if test="billNo != null and billNo != ''">bill_no = #{billNo},</if>
            <if test="refBillNo != null and refBillNo != ''">ref_bill_no = #{refBillNo},</if>
            <if test="supplerId != null">suppler_id = #{supplerId},</if>
            <if test="billDate != null">bill_date = #{billDate},</if>
            <if test="warehouseId != null">warehouse_id = #{warehouseId},</if>
            <if test="departmentId != null">department_id = #{departmentId},</if>
            <if test="billStatus != null">bill_status = #{billStatus},</if>
            <if test="userId != null">user_id = #{userId},</if>
            <if test="billType != null">bill_type = #{billType},</if>
            <if test="delFlag != null">del_flag = #{delFlag},</if>
            <if test="auditDate != null">audit_date = #{auditDate},</if>
            <if test="createBy != null">create_by = #{createBy},</if>
            <if test="createTime != null">create_time = #{createTime},</if>
            <if test="updateBy != null">update_by = #{updateBy},</if>
            <if test="updateTime != null">update_time = #{updateTime},</if>
            <if test="remark != null">remark = #{remark},</if>
            <if test="delPerson != null">del_person = #{delPerson},</if>
            <if test="telephone != null">telephone = #{telephone},</if>
            <if test="totalAmount != null">total_amount = #{totalAmount},</if>
            <if test="invoiceNumber != null">invoice_number = #{invoiceNumber},</if>
            <if test="invoiceAmount != null">invoice_amount = #{invoiceAmount},</if>
            <if test="invoiceTime != null">invoice_time = #{invoiceTime},</if>
            <if test="proPerson != null">pro_person = #{proPerson},</if>
            <if test="returnReason != null and returnReason != ''">return_reason = #{returnReason},</if>
            <if test="isMonthInit != null">is_month_init = #{isMonthInit},</if>
            <if test="receiptConfirmStatus != null">receipt_confirm_status = #{receiptConfirmStatus},</if>
            <if test="auditBy != null">audit_by = #{auditBy},</if>
        </trim>
        where id = #{id}
    </update>

    <update id="updatestkIobillEntry" parameterType="StkIoBillEntry">
        update stk_io_bill_entry
        <trim prefix="SET" suffixOverrides=",">
            <if test="delFlag != null">del_flag = #{delFlag},</if>
        </trim>
        where paren_id = #{parenId}
    </update>


    <select id="selectStkIobillEntryMaterialIsExist" parameterType="Long" resultType="int">
        select count(*) from stk_io_bill_entry
        where del_flag !=1
        and material_id = #{id}
    </select>

    <delete id="deleteStkIoBillEntryByParenIds" parameterType="String">
        update stk_io_bill_entry set del_flag = 1 where paren_id in
        <foreach item="parenId" collection="array" open="(" separator="," close=")">
            #{parenId}
        </foreach>
    </delete>

    <delete id="deleteStkIoBillEntryByParenId" parameterType="Long">
        update stk_io_bill_entry set del_flag = 1 where paren_id = #{parenId}
    </delete>

    <insert id="batchStkIoBillEntry">
        insert into stk_io_bill_entry(paren_id, commodity_id, material_id, unit_price, qty, price, amt, batch_no, batch_number, begin_time, end_time, del_flag, remark, kc_no) values
		<foreach item="item" index="index" collection="list" separator=",">
            (#{item.parenId}, #{item.commodityId}, #{item.materialId}, #{item.unitPrice}, #{item.qty}, #{item.price}, #{item.amt}, #{item.batchNo}, #{item.batchNumber}, #{item.beginTime}, #{item.endTime}, #{item.delFlag}, #{item.remark}, #{item.kcNo})
        </foreach>
    </insert>

    <update id="updateStkIoBillEntryKcNo">
        update stk_io_bill_entry set kc_no = #{kcNo} where id = #{id}
    </update>

    <select id="selectMaxBillNo" resultType="String">
        select max(bill_no) from stk_io_bill
        where bill_no like concat('%',#{billNo},'%')
        and bill_type = 101
    </select>

    <select id="selectOutMaxBillNo" resultType="String">
        select max(bill_no) from stk_io_bill
        where bill_no like concat('%',#{billNo},'%')
        and bill_type = 201
    </select>

    <select id="selectTHMaxBillNo" resultType="String">
        select max(bill_no) from stk_io_bill
        where bill_no like concat('%',#{billNo},'%')
        and bill_type = 301
    </select>

    <select id="selectTKMaxBillNo" resultType="String">
        select max(bill_no) from stk_io_bill
        where bill_no like concat('%',#{billNo},'%')
        and bill_type = 401
    </select>

    <select id="selectJSMaxBillNo" resultType="String">
        select max(bill_no) from stk_io_bill
        where bill_no like concat('%',#{billNo},'%')
        and bill_type = 501
    </select>

    <select id="selectHistoryInventory" parameterType="String" resultType="java.util.HashMap">
        select m.name materialName,sum(b.qty) historyQty from stk_io_bill a
        left join stk_io_bill_entry b on b.paren_id = a.id
        left join fd_material m on b.material_id = m.id
        where a.bill_status = 2
        and a.bill_type = '101'
        and a.create_time concat('%',#{previousDateString},'%')
        GROUP BY m.name
    </select>

    <select id="selectListPurInventory" parameterType="StkIoBill" resultType="java.util.HashMap">
        select id,materialCode,materialName,billNo,billDate,billType,materialQty,price,materialAmt,
                batchNo,batchNumber,beginTime,endTime,materialSpeci,materialModel,unitName,factoryName,
                financeCategoryName,departmentName,warehouseName,supplierName
        from (
            select stk.id,m.code materialCode,m.name materialName, stk.bill_no billNo, stk.bill_date billDate,
                    stk.bill_type billType,b.qty materialQty, b.price price,
                    b.amt materialAmt, b.batch_no batchNo, b.batch_number batchNumber, b.begin_time beginTime,
                    b.end_time endTime,m.speci materialSpeci,m.model materialModel,u.unit_name unitName,
                    f.factory_name factoryName,fc.finance_category_name financeCategoryName,
                    d.name departmentName, w.name warehouseName,s.name supplierName
            from stk_io_bill stk
            left join stk_io_bill_entry b on b.paren_id = stk.id
            left join fd_department d on stk.department_id = d.id
            left join fd_warehouse w on stk.warehouse_id = w.id
            left join fd_material m on b.material_id = m.id
            left join fd_supplier s on s.id = m.supplier_id
            left join fd_factory f on f.factory_id = m.factory_id
            left join fd_unit u on u.unit_id = m.unit_id
            left join fd_finance_category fc on fc.finance_category_id = m.finance_category_id
            where stk.del_flag != 1 and stk.bill_status = 2 and stk.bill_type in (101,301)
            <if test="warehouseId != null "> and stk.warehouse_id = #{warehouseId}</if>
            union
            select stk.id,m.code materialCode,m.name materialName, stk.bill_no billNo, stk.bill_date billDate,
                    stk.bill_type billType,b.qty materialQty, b.unit_price price,
                    b.amt materialAmt, b.batch_no batchNo, b.batch_number batchNumber, b.begin_time beginTime,
                    b.end_time endTime,m.speci materialSpeci,m.model materialModel,u.unit_name unitName,
                    f.factory_name factoryName,fc.finance_category_name financeCategoryName,
                    d.name departmentName, w.name warehouseName,s.name supplierName
            from stk_io_bill stk
            left join stk_io_bill_entry b on b.paren_id = stk.id
            left join fd_department d on stk.department_id = d.id
            left join fd_warehouse w on stk.warehouse_id = w.id
            left join fd_material m on b.material_id = m.id
            left join fd_supplier s on s.id = m.supplier_id
            left join fd_factory f on f.factory_id = m.factory_id
            left join fd_unit u on u.unit_id = m.unit_id
            left join fd_finance_category fc on fc.finance_category_id = m.finance_category_id
            where stk.del_flag != 1 and stk.bill_status = 2 and stk.bill_type in (201,401)
            <if test="warehouseId != null "> and stk.warehouse_id = #{warehouseId}</if>
            union
            -- 调拨单：调出仓库记录（数量为负数，表示出库）
            select stk.id,m.code materialCode,m.name materialName, stk.bill_no billNo, stk.bill_date billDate,
                    stk.bill_type billType,-b.qty materialQty, b.unit_price price,
                    -b.amt materialAmt, b.batch_no batchNo, b.batch_number batchNumber, b.begin_time beginTime,
                    b.end_time endTime,m.speci materialSpeci,m.model materialModel,u.unit_name unitName,
                    f.factory_name factoryName,fc.finance_category_name financeCategoryName,
                    d.name departmentName, w.name warehouseName,s.name supplierName
            from stk_io_bill stk
            left join stk_io_bill_entry b on b.paren_id = stk.id
            left join fd_department d on stk.department_id = d.id
            left join fd_warehouse w on stk.warehouse_id = w.id
            left join fd_material m on b.material_id = m.id
            left join fd_supplier s on s.id = m.supplier_id
            left join fd_factory f on f.factory_id = m.factory_id
            left join fd_unit u on u.unit_id = m.unit_id
            left join fd_finance_category fc on fc.finance_category_id = m.finance_category_id
            where stk.del_flag != 1 and stk.bill_status = 2 and stk.bill_type = 501 and stk.bill_no not like 'JS%'
            <if test="warehouseId != null "> and stk.warehouse_id = #{warehouseId}</if>
            union
            -- 调拨单：调入仓库记录（数量为正数，表示入库）
            select stk.id,m.code materialCode,m.name materialName, stk.bill_no billNo, stk.bill_date billDate,
                    stk.bill_type billType,b.qty materialQty, b.unit_price price,
                    b.amt materialAmt, b.batch_no batchNo, b.batch_number batchNumber, b.begin_time beginTime,
                    b.end_time endTime,m.speci materialSpeci,m.model materialModel,u.unit_name unitName,
                    f.factory_name factoryName,fc.finance_category_name financeCategoryName,
                    d.name departmentName, tw.name warehouseName,s.name supplierName
            from stk_io_bill stk
            left join stk_io_bill_entry b on b.paren_id = stk.id
            left join fd_department d on stk.department_id = d.id
            left join fd_warehouse w on stk.warehouse_id = w.id
            left join fd_warehouse tw on stk.department_id = tw.id
            left join fd_material m on b.material_id = m.id
            left join fd_supplier s on s.id = m.supplier_id
            left join fd_factory f on f.factory_id = m.factory_id
            left join fd_unit u on u.unit_id = m.unit_id
            left join fd_finance_category fc on fc.finance_category_id = m.finance_category_id
            where stk.del_flag != 1 and stk.bill_status = 2 and stk.bill_type = 501 and stk.bill_no not like 'JS%'
            <if test="warehouseId != null "> and stk.department_id = #{warehouseId}</if>
            union
            select a.id,m.code materialCode,m.name materialName, a.stock_no billNo, a.stock_date billDate,
                    a.stock_type billType,b.qty materialQty, b.price price,
                    b.amt materialAmt, b.batch_no batchNo, b.batch_number batchNumber, b.begin_time beginTime,
                    b.end_time endTime,m.speci materialSpeci,m.model materialModel,u.unit_name unitName,
                    f.factory_name factoryName,fc.finance_category_name financeCategoryName,
                    d.name departmentName, w.name warehouseName,s.name supplierName
            from stk_io_stocktaking a
            left join stk_io_stocktaking_entry b on b.paren_id = a.id
            left join fd_department d on a.department_id = d.id
            left join fd_warehouse w on a.warehouse_id = w.id
            left join fd_material m on b.material_id = m.id
            left join fd_supplier s on s.id = m.supplier_id
            left join fd_factory f on f.factory_id = m.factory_id
            left join fd_unit u on u.unit_id = m.unit_id
            left join fd_finance_category fc on fc.finance_category_id = m.finance_category_id
            where a.del_flag != 1 and a.stock_status = 2
        ) t
        <where>
            <if test="billNo != null  and billNo != ''"> and billNo like concat('%', #{billNo}, '%')</if>
            <if test="materialName != null "> and materialName like concat('%', #{materialName}, '%')</if>
            <if test="warehouseName != null "> and warehouseName like concat('%', #{warehouseName}, '%')</if>
            <if test="beginDate != null "> and billDate &gt;= #{beginDate}</if>
            <if test="endDate != null "> and billDate &lt;= #{endDate}</if>
            <if test="params.billTypeList != null and params.billTypeList.size() > 0">
                and billType in
                <foreach collection="params.billTypeList" item="type" open="(" separator="," close=")">
                    #{type}
                </foreach>
            </if>
            <if test="(params.billTypeList == null or params.billTypeList.size() == 0) and billType != null">
                and billType = #{billType}
            </if>
        </where>
    </select>

    <select id="selectMonthInitDataList" resultType="java.util.HashMap">
        select wCategoryName,sum(initAmount) initAmount,sum(beginAmount) beginAmount,sum(endAmount) endAmount,
				sum(beginAmount) - sum(endAmount) settleAmount,
				sum(profitAmount) profitAmount,sum(loseAmount) loseAmount,
				sum(initAmount)+sum(beginAmount)- sum(endAmount) settleRealityAmount
        from (
            select wCategoryName,
                    case when alias = '进项' then totalAmount else 0 end beginAmount,
                    case when alias = '出项' then totalAmount else 0 end endAmount,
                    case when alias = '盘盈' then totalAmount else 0 end profitAmount,
                    case when alias = '盘亏' then totalAmount else 0 end loseAmount,
                    case when alias = '期初' then totalAmount else 0 end initAmount
            from (
                select fw.warehouse_category_name wCategoryName,
                        sum(b.amt) totalAmount,'进项' as alias
                from stk_io_bill stk
                left join stk_io_bill_entry b on b.paren_id = stk.id
                left join fd_material m on b.material_id = m.id
                left join fd_finance_category fc on fc.finance_category_id = m.finance_category_id
                left join fd_warehouse_category fw on fw.warehouse_category_id = m.storeroom_id
                where stk.del_flag != 1 and stk.bill_status = 2 and stk.bill_type in (101)
                and stk.bill_date &gt;= #{beginDate} and stk.bill_date &lt;= #{endDate}
                GROUP BY fw.warehouse_category_name
                union
                select fw.warehouse_category_name wCategoryName,
                        sum(b.amt) totalAmount,'出项' as alias
                from stk_io_bill stk
                left join stk_io_bill_entry b on b.paren_id = stk.id
                left join fd_material m on b.material_id = m.id
                left join fd_finance_category fc on fc.finance_category_id = m.finance_category_id
                left join fd_warehouse_category fw on fw.warehouse_category_id = m.storeroom_id
                where stk.del_flag != 1 and stk.bill_status = 2 and stk.bill_type in (201)
                and stk.bill_date &gt;= #{beginDate} and stk.bill_date &lt;= #{endDate}
                GROUP BY fw.warehouse_category_name
                union
                select fw.warehouse_category_name wCategoryName,
                        sum(b.amt) totalAmount,'盘盈' as alias
                from stk_io_stocktaking a
                left join stk_io_stocktaking_entry b on b.paren_id = a.id
                left join fd_material m on b.material_id = m.id
                left join fd_finance_category fc on fc.finance_category_id = m.finance_category_id
                left join fd_warehouse_category fw on fw.warehouse_category_id = m.storeroom_id
                where a.del_flag != 1 and a.stock_status = 2 and a.stock_type in (502)
                and a.stock_date &gt;= #{beginDate} and a.stock_date &lt;= #{endDate}
                GROUP BY fw.warehouse_category_name
                union
                select fw.warehouse_category_name wCategoryName,
                        sum(b.amt) totalAmount,'盘亏' as alias
                from stk_io_stocktaking a
                left join stk_io_stocktaking_entry b on b.paren_id = a.id
                left join fd_material m on b.material_id = m.id
                left join fd_finance_category fc on fc.finance_category_id = m.finance_category_id
                left join fd_warehouse_category fw on fw.warehouse_category_id = m.storeroom_id
                where a.del_flag != 1 and a.stock_status = 2 and a.stock_type in (502)
                and a.stock_date &gt;= #{beginDate} and a.stock_date &lt;= #{endDate}
                GROUP BY fw.warehouse_category_name
                union
                select DISTINCT wCategoryName,sum(totalAmount) totalAmount,'期初' as alias
                from (
                    select fw.warehouse_category_name wCategoryName,
                            sum(b.amt) totalAmount
                    from stk_io_bill stk
                    left join stk_io_bill_entry b on b.paren_id = stk.id
                    left join fd_material m on b.material_id = m.id
                    left join fd_finance_category fc on fc.finance_category_id = m.finance_category_id
                    left join fd_warehouse_category fw on fw.warehouse_category_id = m.storeroom_id
                    where stk.del_flag != 1 and stk.bill_status = 2 and stk.bill_type in (101,401)
                    and stk.bill_date &gt;= #{beginDate} and stk.bill_date &lt;= #{endDate}
                    GROUP BY fw.warehouse_category_name
                    union
                    select fw.warehouse_category_name wCategoryName,
                            sum(b.stock_amount) totalAmount
                    from stk_io_stocktaking a
                    left join stk_io_stocktaking_entry b on b.paren_id = a.id
                    left join fd_material m on b.material_id = m.id
                    left join fd_finance_category fc on fc.finance_category_id = m.finance_category_id
                    left join fd_warehouse_category fw on fw.warehouse_category_id = m.storeroom_id
                    where a.del_flag != 1 and a.stock_status = 2 and a.stock_type in (502)
                    and a.stock_date &gt;= #{beginDate} and a.stock_date &lt;= #{endDate}
                    GROUP BY fw.warehouse_category_name
                ) qc where 1=1
            GROUP BY wCategoryName
            ) wt
        ) t where 1=1
        GROUP BY wCategoryName
    </select>

    <select id="getMonthHandleDataList" resultMap="StkIoBillResult">
        select * from stk_io_bill
        where bill_date &gt;= #{beginDate} and bill_date &lt;= #{endDate}
    </select>

    <!-- 查询结算明细：根据供应商、日期范围、仓库结算类型查询出库明细，排除已结算的产品 -->
    <select id="selectSettlementDetails" parameterType="StkIoBill" resultMap="StkIoBillEntryResult">
        select 
            b.id as sub_id,
            b.paren_id as sub_paren_id,
            b.commodity_id as sub_commodity_id,
            b.material_id as sub_material_id,
            b.unit_price as sub_unit_price,
            b.qty as sub_qty,
            b.price as sub_price,
            b.amt as sub_amt,
            b.batch_no as sub_batch_no,
            b.batch_number as sub_batch_number,
            b.begin_time as sub_begin_time,
            b.end_time as sub_end_time,
            b.del_flag as sub_del_flag,
            b.remark as sub_remark,
            m.id as mId,
            m.code as materialCode,
            m.name as materialName,
            m.speci,
            m.model,
            m.supplier_id,
            m.storeroom_id,
            m.factory_id,
            m.unit_id,
            m.finance_category_id,
            m.package_speci,
            m.register_no,
            u.unit_id,
            u.unit_code as u_code,
            u.unit_name as u_name,
            f.factory_id,
            f.factory_code as f_code,
            f.factory_name as f_name,
            fc.finance_category_id,
            fc.finance_category_code as fc_code,
            fc.finance_category_name as fc_name,
            wc.warehouse_category_id as wid,
            wc.warehouse_category_code as wc_code,
            wc.warehouse_category_name as wc_name,
            s.id as sid,
            s.code as supplier_code,
            s.name as supplier_name,
            w.id as wId,
            w.name as warehouseName,
            w.settlement_type as settlementType
        from stk_io_bill stk
        left join stk_io_bill_entry b on b.paren_id = stk.id and b.del_flag != 1
        left join fd_warehouse w on stk.warehouse_id = w.id
        left join fd_material m on b.material_id = m.id
        left join fd_unit u on u.unit_id = m.unit_id
        left join fd_factory f on f.factory_id = m.factory_id
        left join fd_finance_category fc on fc.finance_category_id = m.finance_category_id
        left join fd_warehouse_category wc on wc.warehouse_category_id = m.storeroom_id
        left join fd_supplier s on s.id = m.supplier_id
        where stk.del_flag != 1
        and stk.bill_status = 2
        <if test="supplerId != null"> and m.supplier_id = #{supplerId}</if>
        <if test="beginDate != null"> and DATE(stk.audit_date) &gt;= DATE(#{beginDate})</if>
        <if test="endDate != null"> and DATE(stk.audit_date) &lt;= DATE(#{endDate})</if>
        <!-- 根据仓库结算类型筛选：查询所有结算类型的明细 -->
        <!-- 入库结算（settlement_type=1）：查询入库单（bill_type=101） -->
        <!-- 出库结算（settlement_type=2）：查询出库单（bill_type=201） -->
        <!-- 消耗结算（settlement_type=3）：查询出库单（bill_type=201） -->
        <!-- 如果仓库没有设置结算类型，也查询出来（兼容旧数据，查询入库和出库单） -->
        and (
            (w.settlement_type = '1' and stk.bill_type = 101) or
            (w.settlement_type = '2' and stk.bill_type = 201) or
            (w.settlement_type = '3' and stk.bill_type = 201) or
            (w.settlement_type IS NULL and (stk.bill_type = 101 or stk.bill_type = 201))
        )
        <!-- 排除已经生成结算单的产品：检查该产品是否已经在结算单明细中 -->
        and not exists (
            select 1 
            from stk_io_bill settlement
            left join stk_io_bill_entry settlement_entry on settlement_entry.paren_id = settlement.id and settlement_entry.del_flag != 1
            where settlement.del_flag != 1
            and settlement.bill_type = 501
            and settlement_entry.material_id = b.material_id
            and settlement_entry.batch_no = b.batch_no
            and settlement.bill_status = 2
        )
        order by stk.audit_date desc, stk.id desc, b.id desc
    </select>

    <!-- 查询领用明细列表 -->
    <select id="selectConsumeDetailList" parameterType="StkIoBill" resultType="java.util.HashMap">
        SELECT 
            stk.id, stk.bill_no billNo, stk.bill_date billDate, stk.warehouse_id warehouseId, stk.department_id departmentId,
            m.code materialCode, m.name materialName, m.speci materialSpeci, m.model materialModel,
            u.unit_name unitName, b.qty, b.unit_price unitPrice, b.amt,
            b.batch_no batchNo, b.batch_number batchNumber, b.begin_time beginTime, b.end_time endTime,
            w.name warehouseName, d.name departmentName,
            cu.user_name createrName, cu.nick_name createrNickName,
            au.user_name auditPersonName, au.nick_name auditNickName, stk.audit_date auditDate,
            f.factory_name factoryName, s.name supplierName
        FROM stk_io_bill stk
        LEFT JOIN stk_io_bill_entry b ON b.paren_id = stk.id AND b.del_flag != 1
        LEFT JOIN fd_material m ON b.material_id = m.id
        LEFT JOIN fd_department d ON stk.department_id = d.id
        LEFT JOIN fd_warehouse w ON stk.warehouse_id = w.id
        LEFT JOIN fd_unit u ON m.unit_id = u.unit_id
        LEFT JOIN sys_user cu ON stk.create_by = cu.user_id
        LEFT JOIN sys_user au ON stk.audit_by = au.user_id
        LEFT JOIN fd_factory f ON m.factory_id = f.factory_id
        LEFT JOIN fd_supplier s ON m.supplier_id = s.id
        WHERE stk.del_flag != 1 
          AND stk.bill_status = 2 
          AND stk.bill_type = 201
        <if test="billNo != null and billNo != ''"> AND stk.bill_no LIKE CONCAT('%', #{billNo}, '%')</if>
        <if test="warehouseId != null"> AND stk.warehouse_id = #{warehouseId}</if>
        <if test="departmentId != null"> AND stk.department_id = #{departmentId}</if>
        <if test="materialId != null and materialId != ''"> AND m.id = #{materialId}</if>
        <if test="materialName != null and materialName != ''"> AND (m.name LIKE CONCAT('%', #{materialName}, '%') OR m.code LIKE CONCAT('%', #{materialName}, '%'))</if>
        <if test="batchNo != null and batchNo != ''"> AND b.batch_no LIKE CONCAT('%', #{batchNo}, '%')</if>
        <if test="beginDate != null"> AND stk.bill_date &gt;= #{beginDate}</if>
        <if test="endDate != null"> AND stk.bill_date &lt;= #{endDate}</if>
        ORDER BY stk.bill_date DESC, stk.id DESC, b.id DESC
    </select>

    <!-- 查询领用汇总列表（按耗材汇总） -->
    <select id="selectConsumeSummaryList" parameterType="StkIoBill" resultType="java.util.HashMap">
        SELECT 
            m.id materialId, m.code materialCode, m.name materialName, 
            m.speci materialSpeci, m.model materialModel,
            u.unit_name unitName, AVG(b.unit_price) unitPrice,
            SUM(b.qty) totalQty, SUM(b.amt) totalAmt,
            NULL as isBilling, m.register_no registerNo, m.period_date periodDate,
            w.name warehouseName, f.factory_name factoryName, s.name supplierName
        FROM stk_io_bill stk
        LEFT JOIN stk_io_bill_entry b ON b.paren_id = stk.id AND b.del_flag != 1
        LEFT JOIN fd_material m ON b.material_id = m.id
        LEFT JOIN fd_warehouse w ON stk.warehouse_id = w.id
        LEFT JOIN fd_unit u ON m.unit_id = u.unit_id
        LEFT JOIN fd_factory f ON m.factory_id = f.factory_id
        LEFT JOIN fd_supplier s ON m.supplier_id = s.id
        WHERE stk.del_flag != 1 
          AND stk.bill_status = 2 
          AND stk.bill_type = 201
        <if test="warehouseId != null"> AND stk.warehouse_id = #{warehouseId}</if>
        <if test="departmentId != null"> AND stk.department_id = #{departmentId}</if>
        <if test="materialId != null and materialId != ''"> AND m.id = #{materialId}</if>
        <if test="materialName != null and materialName != ''"> AND (m.name LIKE CONCAT('%', #{materialName}, '%') OR m.code LIKE CONCAT('%', #{materialName}, '%'))</if>
        <if test="beginDate != null"> AND stk.bill_date &gt;= #{beginDate}</if>
        <if test="endDate != null"> AND stk.bill_date &lt;= #{endDate}</if>
        GROUP BY m.id, m.code, m.name, m.speci, m.model, u.unit_name, 
                 m.register_no, m.period_date, w.name, f.factory_name, s.name
        ORDER BY totalAmt DESC
    </select>

    <!-- 查询领用排名列表（按金额降序） -->
    <select id="selectConsumeRankingList" parameterType="StkIoBill" resultType="java.util.HashMap">
        SELECT 
            m.id materialId, m.code materialCode, m.name materialName,
            m.speci materialSpeci, m.model materialModel,
            u.unit_name unitName, AVG(b.unit_price) unitPrice,
            SUM(b.qty) totalQty, SUM(b.amt) totalAmt,
            ROUND((SUM(b.amt) / (SELECT IFNULL(SUM(amt), 1) FROM stk_io_bill_entry entry
                INNER JOIN stk_io_bill bill ON bill.id = entry.paren_id
                WHERE bill.del_flag != 1 AND bill.bill_status = 2 AND bill.bill_type = 201
                AND entry.del_flag != 1
                <if test="warehouseId != null"> AND bill.warehouse_id = #{warehouseId}</if>
                <if test="departmentId != null"> AND bill.department_id = #{departmentId}</if>
                <if test="beginDate != null"> AND bill.bill_date &gt;= #{beginDate}</if>
                <if test="endDate != null"> AND bill.bill_date &lt;= #{endDate}</if>
            )) * 100, 2) as percentage,
            f.factory_name factoryName, s.name supplierName
        FROM stk_io_bill stk
        LEFT JOIN stk_io_bill_entry b ON b.paren_id = stk.id AND b.del_flag != 1
        LEFT JOIN fd_material m ON b.material_id = m.id
        LEFT JOIN fd_unit u ON m.unit_id = u.unit_id
        LEFT JOIN fd_factory f ON m.factory_id = f.factory_id
        LEFT JOIN fd_supplier s ON m.supplier_id = s.id
        WHERE stk.del_flag != 1 
          AND stk.bill_status = 2 
          AND stk.bill_type = 201
        <if test="warehouseId != null"> AND stk.warehouse_id = #{warehouseId}</if>
        <if test="departmentId != null"> AND stk.department_id = #{departmentId}</if>
        <if test="beginDate != null"> AND stk.bill_date &gt;= #{beginDate}</if>
        <if test="endDate != null"> AND stk.bill_date &lt;= #{endDate}</if>
        GROUP BY m.id, m.code, m.name, m.speci, m.model, u.unit_name, f.factory_name, s.name
        ORDER BY totalAmt DESC
    </select>

</mapper>
